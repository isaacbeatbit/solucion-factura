---
import Navbar from "../components/Navbar/Navbar.astro";
import Hero from "../components/Hero/Hero.astro";
import Features from "../components/Features/Features.astro";
import Prices from "../components/Prices/Prices.astro";
import Table from "../components/Table/Table.astro";
import CTA from "../components/CTA/CTA.astro";
import Footer from "../components/Footer/Footer.astro";
import WhatsAppFloat from "../components/WhatsAppFloat/WhatsAppFloat.astro";
import "../styles/global.scss";
---

<html lang="es-MX">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <meta name="color-scheme" content="dark light" />
    <title>Solución Factura</title>

    <!-- Script de tema - debe ejecutarse lo antes posible -->
    <script is:inline>
      // theme.js - Script global para inicialización del tema
      // Este script debe ejecutarse lo antes posible para evitar flash del tema incorrecto

      (function () {
        "use strict";

        // Función para inicializar el tema
        function initTheme() {
          const htmlElement = document.documentElement;

          // Obtener el tema guardado en localStorage
          const savedTheme = localStorage.getItem("theme");

          // Detectar preferencia del sistema si no hay tema guardado
          const prefersDark =
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: dark)").matches;

          // Determinar qué tema usar
          let themeToApply;
          if (savedTheme) {
            themeToApply = savedTheme;
          } else {
            // Si no hay tema guardado, usar la preferencia del sistema
            themeToApply = prefersDark ? "dark" : "light";
            // Guardar la preferencia detectada
            localStorage.setItem("theme", themeToApply);
          }

          // Aplicar el tema
          if (themeToApply === "light") {
            htmlElement.setAttribute("data-theme", "light");
          } else {
            htmlElement.removeAttribute("data-theme");
          }
        }

        // Función para escuchar cambios en la preferencia del sistema
        function watchSystemTheme() {
          if (window.matchMedia) {
            const mediaQuery = window.matchMedia(
              "(prefers-color-scheme: dark)",
            );

            mediaQuery.addEventListener("change", (e) => {
              // Solo actualizar si no hay tema guardado manualmente
              const savedTheme = localStorage.getItem("theme");
              if (!savedTheme) {
                const htmlElement = document.documentElement;
                if (e.matches) {
                  // Sistema prefiere oscuro
                  htmlElement.removeAttribute("data-theme");
                  localStorage.setItem("theme", "dark");
                } else {
                  // Sistema prefiere claro
                  htmlElement.setAttribute("data-theme", "light");
                  localStorage.setItem("theme", "light");
                }

                // Disparar evento personalizado
                window.dispatchEvent(
                  new CustomEvent("themeChanged", {
                    detail: {
                      theme: e.matches ? "dark" : "light",
                      source: "system",
                    },
                  }),
                );
              }
            });
          }
        }

        // Función para obtener el tema actual
        function getCurrentTheme() {
          const htmlElement = document.documentElement;
          return htmlElement.getAttribute("data-theme") || "dark";
        }

        // Función para cambiar el tema programáticamente
        function setTheme(theme) {
          const htmlElement = document.documentElement;

          if (theme === "light") {
            htmlElement.setAttribute("data-theme", "light");
          } else {
            htmlElement.removeAttribute("data-theme");
            theme = "dark"; // Normalizar
          }

          localStorage.setItem("theme", theme);

          // Disparar evento personalizado
          window.dispatchEvent(
            new CustomEvent("themeChanged", {
              detail: { theme, source: "manual" },
            }),
          );

          return theme;
        }

        // Función para alternar el tema
        function toggleTheme() {
          const currentTheme = getCurrentTheme();
          const newTheme = currentTheme === "light" ? "dark" : "light";
          return setTheme(newTheme);
        }

        // Inicializar inmediatamente
        initTheme();

        // Configurar el observador del sistema cuando el DOM esté listo
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", watchSystemTheme);
        } else {
          watchSystemTheme();
        }

        // Exponer funciones globales útiles
        window.themeManager = {
          getCurrentTheme,
          setTheme,
          toggleTheme,
          init: initTheme,
        };
      })();
    </script>
  </head>
  <body>
    <Navbar />
    <Hero />
    <Features />
    <Prices />
    <Table />
    <CTA />
    <Footer />
    <WhatsAppFloat />
  </body>
</html>
