---
import Navbar from "../components/Navbar/Navbar.astro";
import Footer from "../components/Footer/Footer.astro";
import WhatsAppFloat from "../components/WhatsAppFloat/WhatsAppFloat.astro";
import "../styles/global.css";

// Plan data
const basicFeatures = [
    {
        name: "Timbres incluidos",
        emprende: "300",
        crece: "600",
        empresa: "1,200",
        premium: "6,000",
        premiumPlus: "10,000",
        isNumber: true,
    },
    {
        name: "MultiEmpresa",
        emprende: false,
        crece: false,
        empresa: true,
        premium: true,
        premiumPlus: true,
    },
    {
        name: "Facturas",
        emprende: true,
        crece: true,
        empresa: true,
        premium: true,
        premiumPlus: true,
    },
    {
        name: "Cotizaciones",
        emprende: false,
        crece: false,
        empresa: false,
        premium: true,
        premiumPlus: true,
    },
    {
        name: "Notas de Venta",
        emprende: false,
        crece: false,
        empresa: false,
        premium: true,
        premiumPlus: true,
    },
    {
        name: "Recibo de Honorarios",
        emprende: true,
        crece: true,
        empresa: true,
        premium: true,
        premiumPlus: true,
    },
    {
        name: "Recibo de Arrendamiento",
        emprende: true,
        crece: true,
        empresa: true,
        premium: true,
        premiumPlus: true,
    },
    {
        name: "Carta Porte",
        emprende: false,
        crece: true,
        empresa: true,
        premium: true,
        premiumPlus: true,
    },
];

const plans = [
    { id: "emprende", name: "Emprende", price: "$327", period: "por a√±o" },
    { id: "crece", name: "Crece", price: "$561", period: "por a√±o" },
    { id: "empresa", name: "Empresa", price: "$1,075", period: "por a√±o" },
    {
        id: "premium",
        name: "Premium",
        price: "$2,324",
        period: "por a√±o",
        featured: true,
    },
    {
        id: "premiumPlus",
        name: "Premium PLUS",
        price: "$3,135",
        period: "por a√±o",
    },
];

const plansJSON = JSON.stringify(plans);
const basicFeaturesJSON = JSON.stringify(basicFeatures);
---

<!doctype html>
<html lang="es-MX">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/png" href="/favicon.png" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <meta name="color-scheme" content="dark light" />
        <title>Registro - Soluci√≥n Factura</title>
        <meta
            name="description"
            content="Comienza tu prueba gratis de Soluci√≥n Factura. Crea tu cuenta y lanza tu sistema de facturaci√≥n electr√≥nica en menos de 5 minutos."
        />
        <!-- Cloudflare Turnstile Resource Hint for Performance -->
        <link
            rel="preconnect"
            href="https://challenges.cloudflare.com"
        />

        <script is:inline>
            (function () {
                const savedTheme = localStorage.getItem("theme");
                const prefersDark =
                    window.matchMedia &&
                    window.matchMedia("(prefers-color-scheme: dark)").matches;
                const theme = savedTheme || (prefersDark ? "dark" : "light");
                const html = document.documentElement;
                if (theme === "dark") {
                    html.setAttribute("data-theme", "dark");
                    html.classList.add("dark");
                } else {
                    html.setAttribute("data-theme", "light");
                    html.classList.remove("dark");
                }
            })();
        </script>
        <script src="../scripts/theme.js"></script>
        <script is:inline define:vars={{ plansJSON, basicFeaturesJSON }}>
            window.__PLANS__ = JSON.parse(plansJSON);
            window.__BASIC_FEATURES__ = JSON.parse(basicFeaturesJSON);
        </script>
        <style>
            /* Hide number input spinners */
            input[type="tel"]::-webkit-outer-spin-button,
            input[type="tel"]::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            input[type="tel"] {
                -moz-appearance: textfield;
            }
        </style>
    </head>

    <body class="min-h-screen">
        <Navbar />

        <div
            id="alert-container"
            class="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-md px-4"
        >
        </div>

        <!-- WhatsApp Tooltip -->
        <div
            id="whatsappTooltip"
            class="hidden fixed z-50 p-5 bg-green-50 dark:bg-green-900 border-2 border-green-500 rounded-xl shadow-2xl w-[90%] max-w-md left-1/2 transform -translate-x-1/2"
            style="top: 6rem;"
        >
            <div class="flex items-start gap-3">
                <svg
                    class="w-6 h-6 text-green-600 dark:text-green-400 flex-shrink-0 mt-0.5"
                    fill="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"
                    ></path>
                </svg>
                <div class="flex-1">
                    <p
                        class="text-sm font-bold text-black dark:text-white mb-1.5 flex items-center gap-2"
                    >
                        Verificaci√≥n por WhatsApp requerida
                    </p>
                    <p
                        class="text-xs text-black dark:text-white/90 leading-relaxed"
                    >
                        Ingresa tu n√∫mero de WhatsApp activo. Te enviaremos un
                        c√≥digo de verificaci√≥n para completar tu registro.
                    </p>
                </div>
                <button
                    id="closeTooltip"
                    type="button"
                    class="flex-shrink-0 w-6 h-6 rounded-lg flex items-center justify-center text-black dark:text-white hover:bg-green-200 dark:hover:bg-green-600 transition-colors"
                >
                    <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <main
            class="min-h-screen pt-4 lg:pt-8 pb-12 dark:bg-black bg-gray-50 relative overflow-hidden"
        >
            <div
                class="absolute inset-0 bg-gradient-to-br from-cyan-500/10 via-transparent to-blue-500/10"
            >
            </div>
            <div
                class="absolute top-20 left-10 w-72 h-72 bg-cyan-500/10 rounded-full blur-3xl"
            >
            </div>
            <div
                class="absolute bottom-20 right-10 w-96 h-96 bg-blue-500/10 rounded-full blur-3xl"
            >
            </div>

            <div class="container mx-auto px-4 lg:px-8 py-8 relative z-10">
                <div
                    class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start max-w-[420px] lg:max-w-none mx-auto"
                >
                    <!-- Plan Info (left on desktop, top on mobile) -->
                    <div class="order-1 lg:sticky lg:top-24 h-fit">
                        <!-- Mobile toggle -->
                        <button
                            type="button"
                            id="toggle-plan-mobile"
                            class="lg:hidden w-full glass rounded-2xl p-4 shadow-xl border-2 dark:border-gray-700/50 border-gray-200/50 flex items-center justify-between cursor-pointer mb-4"
                        >
                            <div
                                class="flex items-center gap-3 pointer-events-none"
                            >
                                <svg
                                    class="w-5 h-5 text-cyan-500"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                    ><path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                    ></path></svg
                                >
                                <span
                                    class="font-semibold dark:text-white text-gray-900"
                                    id="plan-name-mobile-toggle"
                                    >Ver detalles del plan</span
                                >
                            </div>
                            <svg
                                id="toggle-icon-mobile"
                                class="w-5 h-5 dark:text-white text-gray-900 transition-transform pointer-events-none"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                                ><path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path></svg
                            >
                        </button>

                        <!-- Plan info (collapsible on mobile, always visible on desktop) -->
                        <div
                            id="plan-info-container"
                            class="hidden lg:block glass rounded-2xl p-6 shadow-xl border-2 dark:border-gray-700/50 border-gray-200/50"
                        >
                        </div>
                    </div>

                    <!-- Form (right on desktop, bottom on mobile) -->
                    <div class="order-2">
                        <div class="text-center mb-8">
                            <h1
                                class="text-3xl font-bold dark:text-white text-gray-900 mb-3"
                            >
                                Comienza tu prueba gratis
                            </h1>
                            <p
                                class="text-base dark:text-slate-400 text-gray-600"
                            >
                                Crea tu cuenta y lanza tu sistema de facturaci√≥n
                                en minutos
                            </p>
                        </div>

                        <div
                            class="glass rounded-2xl p-8 shadow-xl border-2 dark:border-gray-700/50 border-gray-200/50"
                        >
                            <form id="register-form" class="space-y-4">
                                <div class="space-y-2">
                                    <label
                                        for="name"
                                        class="block text-sm font-medium dark:text-slate-300 text-gray-700"
                                        >Nombre</label
                                    >
                                    <input
                                        type="text"
                                        id="name"
                                        name="name"
                                        required
                                        placeholder="Juan"
                                        class="w-full px-4 py-3 rounded-lg border dark:border-gray-600 border-gray-300 dark:bg-gray-900/50 bg-white dark:text-white text-gray-900 dark:placeholder:text-gray-500 placeholder:text-gray-400 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all duration-200 hover:border-cyan-400"
                                    />
                                </div>

                                <div class="space-y-2">
                                    <label
                                        for="lastName"
                                        class="block text-sm font-medium dark:text-slate-300 text-gray-700"
                                        >Apellido</label
                                    >
                                    <input
                                        type="text"
                                        id="lastName"
                                        name="lastName"
                                        required
                                        placeholder="P√©rez"
                                        class="w-full px-4 py-3 rounded-lg border dark:border-gray-600 border-gray-300 dark:bg-gray-900/50 bg-white dark:text-white text-gray-900 dark:placeholder:text-gray-500 placeholder:text-gray-400 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all duration-200 hover:border-cyan-400"
                                    />
                                </div>

                                <div class="space-y-2">
                                    <label
                                        for="rfc"
                                        class="block text-sm font-medium dark:text-slate-300 text-gray-700"
                                        >RFC</label
                                    >
                                    <input
                                        type="text"
                                        id="rfc"
                                        name="rfc"
                                        required
                                        minlength="12"
                                        maxlength="13"
                                        placeholder="XAXX010101000"
                                        class="w-full px-4 py-3 rounded-lg border dark:border-gray-600 border-gray-300 dark:bg-gray-900/50 bg-white dark:text-white text-gray-900 dark:placeholder:text-gray-500 placeholder:text-gray-400 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all duration-200 hover:border-cyan-400 uppercase"
                                    />
                                    <p
                                        class="text-xs dark:text-gray-500 text-gray-500"
                                    >
                                        12 o 13 caracteres
                                    </p>
                                </div>

                                <div class="space-y-2">
                                    <label
                                        for="phone"
                                        class="block text-sm font-medium dark:text-slate-300 text-gray-700"
                                        >N√∫mero de WhatsApp</label
                                    >
                                    <div class="flex gap-2">
                                        <select
                                            id="countryCode"
                                            name="countryCode"
                                            required
                                            class="w-24 px-3 py-3 rounded-lg border dark:border-gray-600 border-gray-300 dark:bg-gray-900/50 bg-white dark:text-white text-gray-900 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all duration-200 hover:border-cyan-400"
                                        >
                                            <option value="+52" selected
                                                >+52</option
                                            >
                                            <option value="+1">+1</option>
                                        </select>
                                        <input
                                            type="tel"
                                            id="phone"
                                            name="phone"
                                            required
                                            maxlength="10"
                                            pattern="[0-9]{10}"
                                            placeholder="5512345678"
                                            class="flex-1 px-4 py-3 rounded-lg border dark:border-gray-600 border-gray-300 dark:bg-gray-900/50 bg-white dark:text-white text-gray-900 dark:placeholder:text-gray-500 placeholder:text-gray-400 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all duration-200 hover:border-cyan-400"
                                        />
                                    </div>
                                    <p
                                        class="text-xs dark:text-gray-500 text-gray-500"
                                    >
                                        10 d√≠gitos sin espacios ni guiones
                                    </p>
                                </div>

                                <div class="space-y-2">
                                    <label
                                        for="email"
                                        class="block text-sm font-medium dark:text-slate-300 text-gray-700"
                                        >Correo electr√≥nico</label
                                    >
                                    <input
                                        type="email"
                                        id="email"
                                        name="email"
                                        required
                                        placeholder="tu@empresa.com"
                                        class="w-full px-4 py-3 rounded-lg border dark:border-gray-600 border-gray-300 dark:bg-gray-900/50 bg-white dark:text-white text-gray-900 dark:placeholder:text-gray-500 placeholder:text-gray-400 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all duration-200 hover:border-cyan-400"
                                    />
                                </div>

                                <div class="space-y-2">
                                    <label
                                        for="password"
                                        class="block text-sm font-medium dark:text-slate-300 text-gray-700"
                                        >Contrase√±a</label
                                    >
                                    <input
                                        type="password"
                                        id="password"
                                        name="password"
                                        required
                                        minlength="8"
                                        placeholder="M√≠nimo 8 caracteres con s√≠mbolo"
                                        class="w-full px-4 py-3 rounded-lg border dark:border-gray-600 border-gray-300 dark:bg-gray-900/50 bg-white dark:text-white text-gray-900 dark:placeholder:text-gray-500 placeholder:text-gray-400 focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all duration-200 hover:border-cyan-400"
                                    />
                                    <p
                                        id="password-hint"
                                        class="text-xs dark:text-gray-500 text-gray-500"
                                    >
                                        M√≠nimo 8 caracteres, 1 may√∫scula, 1
                                        min√∫scula, 1 n√∫mero y 1 s√≠mbolo
                                    </p>
                                </div>

                                <div class="flex items-start gap-3 pt-2">
                                    <input
                                        type="checkbox"
                                        id="terms"
                                        name="terms"
                                        required
                                        class="mt-1 w-4 h-4 text-cyan-600 dark:bg-gray-900/50 bg-white border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-cyan-500 cursor-pointer"
                                    />
                                    <label
                                        for="terms"
                                        class="text-sm dark:text-slate-400 text-gray-600 leading-relaxed cursor-pointer"
                                    >
                                        Acepto los <a
                                            href="/terminos-y-condiciones"
                                            class="text-cyan-500 hover:text-cyan-600 font-medium underline"
                                            >t√©rminos y condiciones</a
                                        > y la <a
                                            href="/aviso-de-privacidad"
                                            class="text-cyan-500 hover:text-cyan-600 font-medium underline"
                                            >pol√≠tica de privacidad</a
                                        >
                                    </label>
                                </div>

                                <!-- Cloudflare Turnstile Widget -->
                                <div class="flex justify-center mt-6">
                                    <div
                                        class="cf-turnstile"
                                        data-sitekey={import.meta.env
                                            .PUBLIC_TURNSTILE_REGISTER_SITE_KEY}
                                        data-theme="auto"
                                        data-size="flexible"
                                        data-callback="onTurnstileSuccess"
                                        data-error-callback="onTurnstileError"
                                        data-expired-callback="onTurnstileExpired"
                                        data-retry="auto"
                                        data-action="register"
                                        data-cdata="registration-form"
                                    >
                                    </div>
                                </div>

                                <button
                                    type="submit"
                                    id="submit-button"
                                    class="w-full py-3.5 font-semibold text-base mt-6 px-6 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-all duration-200 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    <span id="submit-text"
                                        >Crear cuenta gratis</span
                                    >
                                    <span id="submit-loader" class="hidden"
                                        >Procesando...</span
                                    >
                                </button>
                            </form>

                            <div
                                class="text-center mt-6 pt-6 border-t dark:border-gray-700/50 border-gray-200"
                            >
                                <p
                                    class="text-sm dark:text-slate-400 text-gray-600"
                                >
                                    ¬øYa tienes cuenta? <a
                                        href="/login"
                                        class="text-cyan-500 hover:text-cyan-600 font-semibold transition-colors"
                                        >Inicia sesi√≥n</a
                                    >
                                </p>
                            </div>
                        </div>

                        <!-- <div
                            class="flex items-center justify-center gap-6 mt-8 text-sm dark:text-slate-400 text-gray-600"
                        >
                            <div class="flex items-center gap-2">
                                <svg
                                    class="w-5 h-5 text-cyan-500"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                    ><path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M5 13l4 4L19 7"></path></svg
                                >
                                <span>14 d√≠as gratis</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg
                                    class="w-5 h-5 text-cyan-500"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                    ><path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M5 13l4 4L19 7"></path></svg
                                >
                                <span>Sin tarjeta</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg
                                    class="w-5 h-5 text-cyan-500"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                    ><path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M5 13l4 4L19 7"></path></svg
                                >
                                <span>Setup en 5 min</span>
                            </div>
                        </div> -->
                    </div>
                </div>
            </div>
        </main>

        <Footer />
        <WhatsAppFloat />

        <!-- Cloudflare Turnstile Script -->
        <script
            src="https://challenges.cloudflare.com/turnstile/v0/api.js"
            async
            defer></script>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const plans = window.__PLANS__;
                const basicFeatures = window.__BASIC_FEATURES__;
                const urlParams = new URLSearchParams(window.location.search);
                const planParam = urlParams.get("plan");
                const emailParam = urlParams.get("email");

                // Redirigir al inicio si falta email O plan (deben estar ambos)
                if (!emailParam || !planParam) {
                    window.location.href = "/";
                    return;
                }

                const selectedPlan =
                    plans.find((p) => p.id === planParam) ||
                    plans.find((p) => p.featured);

                // Pre-llenar el email y hacerlo readonly
                const emailInput = document.getElementById("email");
                if (emailInput) {
                    emailInput.value = emailParam;
                    emailInput.readOnly = true;
                    emailInput.classList.add("bg-gray-100", "dark:bg-gray-800", "cursor-not-allowed");
                }

                function renderPlanInfo(container) {
                    if (!selectedPlan) return;
                    const featuresHTML = basicFeatures
                        .map((f) => {
                            const value = f[selectedPlan.id];
                            const icon = f.isNumber
                                ? `<span class="inline-block px-3 py-1.5 rounded-full bg-cyan-500/10 text-cyan-500 font-bold text-sm">${value}</span>`
                                : value
                                  ? `<span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-green-500/20 text-green-500 text-base font-bold">‚úì</span>`
                                  : `<span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-red-500/10 text-red-500/60 text-base">‚úï</span>`;
                            return `<div class="flex items-center justify-between py-2.5 border-b dark:border-gray-700/50 border-gray-200/50 last:border-0"><span class="text-sm dark:text-slate-300 text-gray-700">${f.name}</span>${icon}</div>`;
                        })
                        .join("");

                    container.innerHTML = `
          <div class="text-center mb-6">
            ${selectedPlan.featured ? '<div class="inline-block bg-gradient-to-r from-green-500 to-green-600 text-white px-3 py-1 rounded-full text-xs font-bold mb-3">‚≠ê M√ÅS VENDIDO</div>' : ""}
            <h3 class="text-2xl font-bold dark:text-white text-gray-900 mb-2">${selectedPlan.name}</h3>
            <div class="text-4xl font-bold text-cyan-500 mb-1">${selectedPlan.price}</div>
            <div class="text-sm dark:text-slate-400 text-gray-600 uppercase tracking-wide">${selectedPlan.period}</div>
          </div>
          <div class="space-y-1 mb-6">${featuresHTML}</div>
          <div class="pt-4 border-t dark:border-gray-700/50 border-gray-200/50">
            <div class="flex items-center justify-between text-sm mb-2">
              <span class="dark:text-slate-300 text-gray-700">Subtotal</span>
              <span class="font-semibold dark:text-white text-gray-900">${selectedPlan.price}</span>
            </div>
            <div class="flex items-center justify-between text-sm mb-3">
              <span class="dark:text-slate-300 text-gray-700">Prueba gratis</span>
              <span class="font-semibold text-green-500">14 d√≠as</span>
            </div>
            <div class="flex items-center justify-between text-lg font-bold pt-3 border-t dark:border-gray-700/50 border-gray-200/50">
              <span class="dark:text-white text-gray-900">Total</span>
              <span class="text-cyan-500">${selectedPlan.price}</span>
            </div>
          </div>
        `;
                }

                const planInfoContainer = document.getElementById(
                    "plan-info-container",
                );
                const planNameMobileToggle = document.getElementById(
                    "plan-name-mobile-toggle",
                );

                if (planInfoContainer) renderPlanInfo(planInfoContainer);
                if (planNameMobileToggle && selectedPlan)
                    planNameMobileToggle.textContent = `Plan ${selectedPlan.name}`;

                // Mobile toggle
                const toggleBtn = document.getElementById("toggle-plan-mobile");
                const toggleIcon =
                    document.getElementById("toggle-icon-mobile");

                if (toggleBtn && planInfoContainer) {
                    toggleBtn.onclick = () => {
                        const isHidden =
                            planInfoContainer.classList.contains("hidden");
                        planInfoContainer.classList.toggle("hidden");
                        if (toggleIcon)
                            toggleIcon.style.transform = isHidden
                                ? "rotate(180deg)"
                                : "rotate(0deg)";
                    };
                }

                // WhatsApp Tooltip functionality
                const phoneInput = document.getElementById("phone");
                const whatsappTooltip = document.getElementById("whatsappTooltip");
                const closeTooltipBtn = document.getElementById("closeTooltip");

                // Only allow numbers in phone input
                phoneInput?.addEventListener("input", (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, "");
                });

                // Prevent non-numeric keypress
                phoneInput?.addEventListener("keypress", (e) => {
                    if (!/[0-9]/.test(e.key) && e.key !== "Backspace" && e.key !== "Delete" && e.key !== "Tab" && e.key !== "ArrowLeft" && e.key !== "ArrowRight") {
                        e.preventDefault();
                    }
                });

                // Show tooltip when phone field receives focus
                phoneInput?.addEventListener("focus", () => {
                    if (whatsappTooltip) {
                        whatsappTooltip.classList.remove("hidden");
                    }
                });

                // Close tooltip with X button
                closeTooltipBtn?.addEventListener("click", (e) => {
                    e.stopPropagation();
                    if (whatsappTooltip) {
                        whatsappTooltip.classList.add("hidden");
                    }
                });

                // Close tooltip when clicking outside
                document.addEventListener("click", (e) => {
                    const target = e.target;
                    if (
                        whatsappTooltip &&
                        !whatsappTooltip.contains(target) &&
                        target !== phoneInput &&
                        !whatsappTooltip.classList.contains("hidden")
                    ) {
                        whatsappTooltip.classList.add("hidden");
                    }
                });

                // RFC auto-uppercase
                const rfcInput = document.getElementById("rfc");
                if (rfcInput)
                    rfcInput.oninput = (e) =>
                        (e.target.value = e.target.value.toUpperCase());

                // Password validation
                const passwordInput = document.getElementById("password");
                const passwordHint = document.getElementById("password-hint");
                if (passwordInput && passwordHint) {
                    passwordInput.oninput = () => {
                        const p = passwordInput.value;
                        const errors = [];
                        if (p.length < 8) errors.push("8+ caracteres");
                        if (!/[A-Z]/.test(p)) errors.push("1 may√∫scula");
                        if (!/[a-z]/.test(p)) errors.push("1 min√∫scula");
                        if (!/\d/.test(p)) errors.push("1 n√∫mero");
                        if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(p))
                            errors.push("1 s√≠mbolo");

                        if (errors.length > 0) {
                            passwordHint.textContent = `Falta: ${errors.join(", ")}`;
                            passwordHint.className = "text-xs text-red-500";
                        } else {
                            passwordHint.textContent =
                                "M√≠nimo 8 caracteres, 1 may√∫scula, 1 min√∫scula, 1 n√∫mero y 1 s√≠mbolo";
                            passwordHint.className =
                                "text-xs dark:text-gray-500 text-gray-500";
                        }
                    };
                }

                // Turnstile verification state
                let turnstileVerified = false;
                const submitBtn = document.getElementById("submit-button");
                
                // Disable submit button until Turnstile is complete
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.style.opacity = "0.6";
                    submitBtn.style.cursor = "not-allowed";
                }

                // Turnstile callbacks
                window.onTurnstileSuccess = function (token) {
                    console.log("‚úÖ Turnstile verificado exitosamente");
                    turnstileVerified = true;
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = "1";
                        submitBtn.style.cursor = "pointer";
                    }
                };

                window.onTurnstileError = function (error) {
                    console.error("‚ùå Error en Turnstile:", error);
                    turnstileVerified = false;
                    showAlert(
                        "Error en la verificaci√≥n de seguridad. Por favor recarga la p√°gina.",
                        "error",
                    );
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.style.opacity = "0.6";
                        submitBtn.style.cursor = "not-allowed";
                    }
                };

                window.onTurnstileExpired = function () {
                    console.warn("‚ö†Ô∏è Token de Turnstile expirado");
                    turnstileVerified = false;
                    showAlert(
                        "La verificaci√≥n de seguridad ha expirado. Por favor compl√©tala nuevamente.",
                        "error",
                    );
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.style.opacity = "0.6";
                        submitBtn.style.cursor = "not-allowed";
                    }
                };

                // Form submission
                const form = document.getElementById("register-form");
                const submitText = document.getElementById("submit-text");
                const submitLoader = document.getElementById("submit-loader");

                function showAlert(msg, type = "error") {
                    const alert = document.createElement("div");
                    const bgColor =
                        type === "error" ? "bg-red-500" : "bg-green-500";
                    alert.className = `${bgColor} text-white px-6 py-4 rounded-lg shadow-lg mb-3`;
                    alert.textContent = msg;
                    document
                        .getElementById("alert-container")
                        .appendChild(alert);
                    setTimeout(() => alert.remove(), 5000);
                }

                if (form) {
                    form.onsubmit = async (e) => {
                        e.preventDefault();

                        // Verify Turnstile is complete
                        if (!turnstileVerified) {
                            showAlert(
                                "Por favor completa la verificaci√≥n de seguridad",
                                "error",
                            );
                            return;
                        }

                        const formData = new FormData(form);
                        const password = formData.get("password");
                        const rfc = formData.get("rfc");

                        const passwordRegex =
                            /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,}$/;
                        if (!passwordRegex.test(password)) {
                            showAlert("La contrase√±a no cumple los requisitos");
                            return;
                        }

                        if (rfc.length < 12 || rfc.length > 13) {
                            showAlert(
                                "El RFC debe tener entre 12 y 13 caracteres",
                            );
                            return;
                        }

                        submitBtn.disabled = true;
                        submitText.classList.add("hidden");
                        submitLoader.classList.remove("hidden");

                        // Get Turnstile token
                        const turnstileResponse = window.turnstile?.getResponse();

                        if (!turnstileResponse) {
                            showAlert(
                                "Por favor completa la verificaci√≥n de seguridad",
                                "error",
                            );
                            submitBtn.disabled = false;
                            submitText.classList.remove("hidden");
                            submitLoader.classList.add("hidden");
                            return;
                        }

                        const countryCode = formData.get("countryCode");
                        const phone = formData.get("phone");
                        const whatsappNumber = `${countryCode.replace("+", "")}1${phone}`;

                        const data = {
                            name: formData.get("name"),
                            last_name: formData.get("lastName"),
                            rfc: rfc,
                            email: formData.get("email"),
                            password: password,
                            whatsapp_number: whatsappNumber,
                            plan: selectedPlan?.id || "premium",
                            cf_turnstile_token: turnstileResponse,
                        };

                        try {
                            const response = await fetch(
                                "https://flow.wabotify.com/webhook/0adde39b-6c95-4dc6-bb7a-0b9401a024c6",
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify(data),
                                },
                            );

                            const result = await response.json();
                            console.log("=== RESPUESTA DEL WEBHOOK ===");
                            console.log("Status HTTP:", response.status);
                            console.log("Code:", result.code);
                            console.log("Message:", result.message);
                            console.log("Respuesta completa:", result);
                            console.log("=============================");

                            // Manejar respuesta del webhook
                            if (result.code === "CODE_SENT") {
                                // C√≥digo OTP enviado a WhatsApp - mostrar √©xito
                                console.log("‚úÖ C√≥digo de verificaci√≥n enviado");
                                showAlert(
                                    "Te hemos enviado un c√≥digo de confirmaci√≥n a tu WhatsApp",
                                    "success",
                                );
                                // Guardar datos en sessionStorage para la verificaci√≥n
                                // Agregar timestamp de expiraci√≥n (5 minutos desde ahora)
                                const expiresAt = Date.now() + 5 * 60 * 1000;
                                sessionStorage.setItem(
                                    "registration_data",
                                    JSON.stringify({
                                        ...data,
                                        expiresAt,
                                    }),
                                );
                                // Redirigir a p√°gina de verificaci√≥n
                                setTimeout(() => {
                                    window.location.href = "/verify";
                                }, 1500);
                            } else if (result.code === "USER_EXISTS") {
                                // Usuario ya registrado con ese email o RFC
                                console.warn("‚ö†Ô∏è Usuario ya existe");
                                showAlert(
                                    "Ya existe una cuenta con este correo electr√≥nico o RFC. Si olvidaste tu contrase√±a, puedes recuperarla desde el login.",
                                    "error",
                                );
                                // Reset Turnstile para permitir reintentar
                                turnstileVerified = false;
                                window.turnstile?.reset();
                                submitBtn.disabled = true;
                                submitText.classList.remove("hidden");
                                submitLoader.classList.add("hidden");
                            } else if (result.code === "REGISTRATION_FAILED") {
                                // Error en el registro (Turnstile inv√°lido u otro error)
                                console.warn("‚ö†Ô∏è Fallo en el registro");
                                showAlert(
                                    "No se pudo completar el registro. Por favor intenta de nuevo.",
                                    "error",
                                );
                                // Reset Turnstile para permitir reintentar
                                turnstileVerified = false;
                                window.turnstile?.reset();
                                submitBtn.disabled = true;
                                submitText.classList.remove("hidden");
                                submitLoader.classList.add("hidden");
                            } else {
                                // Error desconocido - mostrar mensaje gen√©rico
                                console.error("‚ö†Ô∏è Error desconocido:", result);
                                showAlert(
                                    "Hubo un error al crear la cuenta. Por favor intenta de nuevo.",
                                    "error",
                                );
                                // Reset Turnstile para permitir reintentar
                                turnstileVerified = false;
                                window.turnstile?.reset();
                                submitBtn.disabled = true;
                                submitText.classList.remove("hidden");
                                submitLoader.classList.add("hidden");
                            }
                        } catch (error) {
                            console.error("üí• ERROR CR√çTICO al enviar el formulario:");
                            console.error("Tipo de error:", error);
                            console.error(
                                "Stack trace:",
                                error instanceof Error ? error.stack : "N/A",
                            );
                            showAlert(
                                "Hubo un error al crear la cuenta. Por favor intenta de nuevo.",
                                "error",
                            );
                            // Reset Turnstile para permitir reintentar
                            turnstileVerified = false;
                            window.turnstile?.reset();
                            submitBtn.disabled = true;
                            submitText.classList.remove("hidden");
                            submitLoader.classList.add("hidden");
                        }
                    };
                }
            });
        </script>
    </body>
</html>
