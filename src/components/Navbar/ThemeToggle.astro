---
// ThemeToggle.astro - Componente para cambiar entre tema claro y oscuro
---

<button
  id="theme-toggle"
  class="relative bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-full w-11 h-11 cursor-pointer flex items-center justify-center transition-[transform,box-shadow] duration-300 hover:border-blue-600 hover:bg-gray-50 dark:hover:bg-gray-700 hover:scale-105 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 overflow-visible"
  aria-label="Cambiar tema"
  title="Cambiar tema"
>
  <span class="absolute text-xl hidden dark:block" aria-hidden="true">☀️</span>
  <span class="absolute text-xl block dark:hidden" aria-hidden="true">☾</span>
</button>

<script>
  function initThemeToggle() {
    const themeToggle = document.getElementById("theme-toggle");

    if (!themeToggle) return;

    // Manejar el click del toggle usando el themeManager global
    themeToggle.addEventListener("click", () => {
      if ((window as any).themeManager) {
        (window as any).themeManager.toggleTheme();
      } else {
        // Fallback si themeManager no está disponible
        const htmlElement = document.documentElement;
        const currentTheme = htmlElement.getAttribute("data-theme");

        if (currentTheme === "light") {
          htmlElement.removeAttribute("data-theme");
          localStorage.setItem("theme", "dark");
        } else {
          htmlElement.setAttribute("data-theme", "light");
          localStorage.setItem("theme", "light");
        }

        window.dispatchEvent(
          new CustomEvent("themeChanged", {
            detail: { theme: htmlElement.getAttribute("data-theme") || "dark" },
          }),
        );
      }
    });

    // Actualizar el estado visual del toggle
    function updateToggleState() {
      const currentTheme = (window as any).themeManager
        ? (window as any).themeManager.getCurrentTheme()
        : document.documentElement.getAttribute("data-theme") || "dark";

      // Actualizar el aria-label según el tema actual
      const newTheme = currentTheme === "light" ? "oscuro" : "claro";
      themeToggle.setAttribute("aria-label", `Cambiar a tema ${newTheme}`);
      themeToggle.setAttribute("title", `Cambiar a tema ${newTheme}`);
    }

    // Escuchar cambios de tema para actualizar el estado
    window.addEventListener("themeChanged", updateToggleState);

    // Actualizar estado inicial
    updateToggleState();
  }

  // Ejecutar cuando el DOM esté listo
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initThemeToggle);
  } else {
    initThemeToggle();
  }

  // Re-inicializar en navegación de Astro
  document.addEventListener("astro:page-load", initThemeToggle);
</script>
