---

---

<script>
  let selectedPlan = null;
  let showModal = false;

  function openModal(plan) {
    selectedPlan = plan;
    showModal = true;
    document.body.style.overflow = "hidden";
    updateModal();
  }

  function closeModal() {
    showModal = false;
    document.body.style.overflow = "";
    updateModal();
  }

  function updateModal() {
    const modal = document.getElementById("plan-modal");
    if (modal) {
      modal.style.display = showModal ? "flex" : "none";
    }
  }

  // Cerrar modal al hacer click fuera del contenido
  window.addEventListener("click", function (e) {
    const modal = document.getElementById("plan-modal");
    if (showModal && modal && e.target === modal) {
      closeModal();
    }
  });
</script>

<section
  id="planes"
  class="py-12 md:py-16 lg:py-20 bg-gradient-to-br from-bg-primary-light to-bg-secondary-light dark:from-bg-primary dark:to-bg-secondary overflow-x-hidden transition-[background-color,color] duration-300"
>
  <div class="w-full max-w-[1200px] mx-auto px-4 sm:px-6 md:px-8 lg:px-10">
    <div class="text-center mb-10 md:mb-12 lg:mb-16 px-4 md:px-0 box-border">
      <h2
        class="text-3xl md:text-4xl lg:text-5xl font-bold text-text-primary-light dark:text-text-primary mb-4"
      >
        Planes que se adaptan a tu negocio
      </h2>
      <p
        class="text-lg md:text-xl text-text-primary-light dark:text-text-primary leading-relaxed"
      >
        Desde emprendedores hasta grandes empresas, tenemos el plan perfecto
        para ti
      </p>
    </div>

    <div
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 mx-4 md:mx-0 items-stretch max-w-full lg:max-w-none lg:mx-0"
    >
      <div
        class="flex flex-col bg-bg-primary-light dark:bg-bg-primary/80 backdrop-blur-[10px] p-6 md:p-7 lg:p-8 rounded-2xl border border-border-light-mode dark:border-border-light shadow-md transition-all duration-300 min-h-[360px] md:min-h-[380px] lg:min-h-[400px] hover:shadow-lg hover:shadow-blue-500/20 hover:border-blue-500/40 lg:hover:-translate-y-1"
      >
        <h3 class="text-2xl font-bold text-secondary mb-2">Empresa</h3>
        <div class="flex items-baseline gap-2 flex-wrap mb-6 md:mb-5">
          <span
            class="text-4xl md:text-[2.25rem] font-extrabold text-text-primary-light dark:text-text-primary leading-none flex items-baseline"
          >
            <span class="text-base align-super">$</span>1,075
          </span>
          <span
            class="text-base text-text-secondary-light dark:text-text-secondary font-medium whitespace-nowrap ml-1 opacity-90"
            >por año</span
          >
        </div>

        <ul class="list-none p-0 mb-auto flex-grow space-y-2">
          <li
            class="flex items-center gap-3 text-text-primary-light dark:text-text-primary text-[0.95rem] py-[0.4rem]"
          >
            <span
              class="flex items-center justify-center w-5 h-5 rounded-full bg-accent text-white text-xs font-bold shrink-0"
              >✓</span
            >
            1,200 timbres incluidos
          </li>
          <li
            class="flex items-center gap-3 text-text-primary-light dark:text-text-primary text-[0.95rem] py-[0.4rem]"
          >
            <span
              class="flex items-center justify-center w-5 h-5 rounded-full bg-accent text-white text-xs font-bold shrink-0"
              >✓</span
            >
            50 Empresas
          </li>
          <li
            class="flex items-center gap-3 text-text-primary-light dark:text-text-primary text-[0.95rem] py-[0.4rem]"
          >
            <span
              class="flex items-center justify-center w-5 h-5 rounded-full bg-accent text-white text-xs font-bold shrink-0"
              >✓</span
            >
            Facturas y complementos
          </li>
          <li
            class="flex items-center gap-3 text-text-primary-light dark:text-text-primary text-[0.95rem] py-[0.4rem]"
          >
            <span
              class="flex items-center justify-center w-5 h-5 rounded-full bg-accent text-white text-xs font-bold shrink-0"
              >✓</span
            >
            Soporte por email
          </li>
        </ul>

        <button
          type="button"
          class="plan-button w-full flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all duration-200 cursor-pointer bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-md hover:-translate-y-1 hover:shadow-lg mt-4 shrink-0"
          data-plan="empresa"
        >
          Comenzar Ahora
        </button>
      </div>

      <div
        class="relative flex flex-col bg-bg-primary-light dark:bg-bg-primary/80 backdrop-blur-[10px] p-6 md:p-8 rounded-2xl border-2 border-green-500 shadow-lg shadow-green-500/30 transition-all duration-300 hover:-translate-y-2 hover:shadow-xl hover:shadow-green-500/40 scale-105"
      >
        <div
          class="absolute -top-4 left-1/2 -translate-x-1/2 bg-green-500 text-white px-4 py-1 rounded-full text-sm font-semibold shadow-lg"
        >
          Más Popular
        </div>
        <h3 class="text-xl md:text-2xl font-bold text-secondary mb-4 mt-2">
          Premium
        </h3>
        <div class="mb-6">
          <span class="block">
            <span
              class="text-4xl md:text-5xl font-bold text-text-primary-light dark:text-text-primary"
              >$2,324</span
            >
          </span>
          <span
            class="text-sm text-text-secondary-light dark:text-text-secondary"
            >por año</span
          >
        </div>

        <ul class="list-none p-0 my-6 space-y-3 flex-1">
          <li
            class="flex items-start gap-2 text-text-secondary-light dark:text-text-secondary"
          >
            <span class="text-secondary font-bold">✓</span> 6,000 timbres incluidos
          </li>
          <li
            class="flex items-start gap-2 text-text-secondary-light dark:text-text-secondary"
          >
            <span class="text-secondary font-bold">✓</span> Empresas ilimitadas
          </li>
          <li
            class="flex items-start gap-2 text-text-secondary-light dark:text-text-secondary"
          >
            <span class="text-secondary font-bold">✓</span> Envío por WhatsApp
          </li>
          <li
            class="flex items-start gap-2 text-text-secondary-light dark:text-text-secondary"
          >
            <span class="text-secondary font-bold">✓</span> Descarga XML masiva
          </li>
          <li
            class="flex items-start gap-2 text-text-secondary-light dark:text-text-secondary"
          >
            <span class="text-secondary font-bold">✓</span> Importa historial
          </li>
          <li
            class="flex items-start gap-2 text-text-secondary-light dark:text-text-secondary"
          >
            <span class="text-secondary font-bold">✓</span> Conciliación bancaria
          </li>
          <li
            class="flex items-start gap-2 text-text-secondary-light dark:text-text-secondary"
          >
            <span class="text-secondary font-bold">✓</span> Soporte prioritario
          </li>
        </ul>

        <button
          type="button"
          class="plan-button w-full flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all duration-200 cursor-pointer bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-md hover:-translate-y-1 hover:shadow-lg mt-4 shrink-0"
          data-plan="premium"
        >
          Más Popular
        </button>
      </div>

      <div
        class="flex flex-col bg-bg-primary-light dark:bg-bg-primary/80 backdrop-blur-[10px] p-6 md:p-8 rounded-2xl border border-border-light-mode dark:border-border-light shadow-md transition-all duration-300 hover:-translate-y-2 hover:shadow-xl"
      >
        <h3 class="text-xl md:text-2xl font-bold text-secondary mb-4">
          Premium PLUS
        </h3>
        <div class="mb-6">
          <span class="block">
            <span
              class="text-4xl md:text-5xl font-bold text-text-primary-light dark:text-text-primary"
              >$3,135</span
            >
          </span>
          <span
            class="text-sm text-text-secondary-light dark:text-text-secondary"
            >por año</span
          >
        </div>

        <ul class="list-none p-0 my-6 space-y-3 flex-1">
          <li
            class="flex items-start gap-2 text-text-secondary-light dark:text-text-secondary"
          >
            <span class="text-secondary font-bold">✓</span> 10,000 timbres incluidos
          </li>
          <li
            class="flex items-start gap-2 text-text-secondary-light dark:text-text-secondary"
          >
            <span class="text-secondary font-bold">✓</span> AutoFactura incluida
          </li>
          <li
            class="flex items-start gap-2 text-text-secondary-light dark:text-text-secondary"
          >
            <span class="text-secondary font-bold">✓</span> WhatsApp con tu número
          </li>
          <li
            class="flex items-start gap-2 text-text-secondary-light dark:text-text-secondary"
          >
            <span class="text-secondary font-bold">✓</span> Email personalizado
          </li>
          <li
            class="flex items-start gap-2 text-text-secondary-light dark:text-text-secondary"
          >
            <span class="text-secondary font-bold">✓</span> Complementos avanzados
          </li>
          <li
            class="flex items-start gap-2 text-text-secondary-light dark:text-text-secondary"
          >
            <span class="text-secondary font-bold">✓</span> Generación DIOT
          </li>
          <li
            class="flex items-start gap-2 text-text-secondary-light dark:text-text-secondary"
          >
            <span class="text-secondary font-bold">✓</span> Soporte dedicado
          </li>
        </ul>

        <button
          type="button"
          class="plan-button w-full flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all duration-200 cursor-pointer bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-md hover:-translate-y-1 hover:shadow-lg mt-4 shrink-0"
          data-plan="premium-plus"
        >
          Plan Completo
        </button>
      </div>
    </div>
  </div>
</section>

<!-- Modal centrado para selección de cuenta -->
<style>
  #plan-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.45);
    align-items: center;
    justify-content: center;
  }
  #plan-modal.active {
    display: flex;
  }
</style>
<div id="plan-modal">
  <div
    class="bg-bg-card-light dark:bg-bg-card text-text-primary-light dark:text-text-primary rounded-xl max-w-[420px] w-[90vw] p-8 pt-8 pb-6 shadow-xl border border-border-light-mode dark:border-border-light text-center relative"
  >
    <button
      class="close-modal absolute top-4 right-4 bg-transparent border-none text-2xl text-text-secondary-light dark:text-text-secondary cursor-pointer transition-colors hover:text-text-primary-light dark:hover:text-text-primary"
      aria-label="Cerrar">&times;</button
    >
    <div class="text-[1.35rem] font-bold mb-2 text-secondary">
      Continuar con tu compra
    </div>
    <div
      class="text-sm text-text-secondary-light dark:text-text-secondary mb-6"
    >
      Ingresa tu correo electrónico para continuar
    </div>

    <form id="plan-form">
      <div class="text-left mb-4">
        <label
          for="email-input"
          class="block text-sm font-semibold mb-2 text-text-primary-light dark:text-text-primary"
          >Correo electrónico:</label
        >
        <input
          type="email"
          id="email-input"
          name="email"
          placeholder="tu@correo.com"
          required
          autocomplete="email"
          class="w-full px-3 py-3 border border-border-light-mode dark:border-border-light rounded-lg text-base bg-bg-secondary-light dark:bg-bg-secondary text-text-primary-light dark:text-text-primary transition-all focus:outline-none focus:border-secondary focus:bg-bg-primary-light dark:focus:bg-bg-primary"
        />
      </div>

      <div
        class="bg-bg-secondary-light dark:bg-bg-secondary px-3 py-3 rounded-lg mb-6 text-sm border border-border-light-mode dark:border-border-light"
      >
        Plan seleccionado: <strong
          id="selected-plan-name"
          class="text-secondary capitalize">-</strong
        >
      </div>

      <div
        class="error-message hidden text-red-500 text-sm mt-2"
        id="error-message"
      >
      </div>
      <div
        class="loading hidden mt-4 text-text-secondary-light dark:text-text-secondary text-sm"
        id="loading-message"
      >
        Procesando...
      </div>
      <div
        class="success-message hidden mt-4 p-4 bg-bg-secondary-light dark:bg-bg-secondary border border-accent rounded-lg text-text-primary-light dark:text-text-primary text-sm leading-relaxed"
        id="success-message"
      >
        <strong class="text-accent block mb-2">✓ Redirigiendo...</strong>
        Serás redirigido a otra página para completar tu pago.
      </div>

      <div class="flex gap-3 mt-6">
        <button
          type="button"
          class="btn-cancel flex-1 px-4 py-3 rounded-lg font-semibold border border-secondary cursor-pointer transition-all text-base bg-bg-secondary-light dark:bg-bg-secondary text-secondary hover:bg-bg-tertiary-light dark:hover:bg-bg-tertiary"
          >Cancelar</button
        >
        <button
          type="submit"
          class="btn-submit flex-1 px-4 py-3 rounded-lg font-semibold border-none cursor-pointer transition-all text-base bg-secondary text-white hover:bg-highlight disabled:bg-gray-400 disabled:cursor-not-allowed disabled:opacity-50"
          >Continuar</button
        >
      </div>
    </form>
  </div>
</div>
<script>
  // Variable global para compartir con Table.astro
  if (typeof window !== "undefined") {
    window.currentPlan = null;
  }
  let currentPlan = null;

  // Mapeo de planes a nombres de API - compartido globalmente
  // Estos nombres deben coincidir con los IDs en register.astro
  if (typeof window !== "undefined") {
    window.planApiNames = {
      emprende: "emprende",
      crece: "crece",
      empresa: "empresa",
      premium: "premium",
      "premium-plus": "premiumPlus",
    };
  }
  const planApiNames = {
    emprende: "emprende",
    crece: "crece",
    empresa: "empresa",
    premium: "premium",
    "premium-plus": "premiumPlus",
  };

  // URLs de fallback por si falla la API
  const planUrls = {
    emprende: {
      subscribe:
        "https://pagos.solucionfiscal.online/subscribe/6677460f60546edc2553076f/plan-emprende",
      register: "https://app.solucionfactura.mx/register?plan=emprende",
    },
    crece: {
      subscribe:
        "https://pagos.solucionfiscal.online/subscribe/6677544560546edc255308ea/plan-crece",
      register: "https://app.solucionfactura.mx/register?plan=crece",
    },
    empresa: {
      subscribe:
        "https://pagos.solucionfiscal.online/subscribe/667754e89b6a9adc0e5693f1/plan-empresa",
      register: "https://app.solucionfactura.mx/register?plan=empresa",
    },
    premium: {
      subscribe:
        "https://pagos.solucionfiscal.online/subscribe/6677554f9b6a9adc0e5693f6/plan-premium",
      register: "https://app.solucionfactura.mx/register?plan=premium",
    },
    "premium-plus": {
      subscribe:
        "https://pagos.solucionfiscal.online/subscribe/667756fe9b6a9adc0e569424/plan-premium-plus",
      register: "https://app.solucionfactura.mx/register?plan=premium-plus",
    },
  };

  // Función para formatear el nombre del plan
  function formatPlanName(plan) {
    return plan.replace(/-/g, " ").replace(/\b\w/g, (l) => l.toUpperCase());
  }

  // Abrir modal al hacer click en cualquier botón de plan
  document.querySelectorAll(".plan-button").forEach((btn) => {
    btn.addEventListener("click", function (e) {
      e.preventDefault();
      currentPlan = btn.getAttribute("data-plan");
      if (typeof window !== "undefined") {
        window.currentPlan = currentPlan;
      }
      const modal = document.getElementById("plan-modal");
      const planNameEl = document.getElementById("selected-plan-name");
      const emailInput = document.getElementById("email-input");
      const errorMessage = document.getElementById("error-message");

      // Actualizar nombre del plan
      planNameEl.textContent = formatPlanName(currentPlan);

      // Limpiar formulario
      emailInput.value = "";
      errorMessage.classList.add("hidden");
      errorMessage.classList.remove("block");
      errorMessage.textContent = "";

      // Mostrar modal
      modal.classList.add("active");
      document.body.style.overflow = "hidden";

      // Focus en el input
      setTimeout(() => emailInput.focus(), 100);
    });
  });

  // Cerrar modal
  function closeModalHandler() {
    const modal = document.getElementById("plan-modal");
    const submitBtn = document.querySelector(".btn-submit");
    const successMessage = document.getElementById("success-message");
    const loadingMessage = document.getElementById("loading-message");
    const errorMessage = document.getElementById("error-message");

    modal.classList.remove("active");
    document.body.style.overflow = "";
    currentPlan = null;
    if (typeof window !== "undefined") {
      window.currentPlan = null;
    }

    // Resetear estado del botón y mensajes
    if (submitBtn) submitBtn.disabled = false;
    if (successMessage) {
      successMessage.classList.add("hidden");
      successMessage.classList.remove("block");
    }
    if (loadingMessage) {
      loadingMessage.classList.add("hidden");
      loadingMessage.classList.remove("block");
    }
    if (errorMessage) {
      errorMessage.classList.add("hidden");
      errorMessage.classList.remove("block");
    }
  }

  // Cerrar modal al hacer click en la X o botón cancelar
  document
    .querySelector("#plan-modal .close-modal")
    .addEventListener("click", closeModalHandler);
  document
    .querySelector("#plan-modal .btn-cancel")
    .addEventListener("click", closeModalHandler);

  // Cerrar modal al hacer click fuera del contenido
  document.getElementById("plan-modal").addEventListener("click", function (e) {
    if (e.target === this) {
      closeModalHandler();
    }
  });

  // Manejar envío del formulario
  document
    .getElementById("plan-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const emailInput = document.getElementById("email-input");
      const submitBtn = document.querySelector(".btn-submit");
      const errorMessage = document.getElementById("error-message");
      const loadingMessage = document.getElementById("loading-message");
      const email = emailInput.value.trim();

      // Obtener currentPlan de variable local o global
      const planToUse =
        currentPlan ||
        (typeof window !== "undefined" ? window.currentPlan : null);

      if (!email || !planToUse) return;

      // Validar email básico
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        errorMessage.textContent = "Por favor ingresa un correo válido";
        errorMessage.classList.remove("hidden");
        errorMessage.classList.add("block");
        return;
      }

      // Ocultar error y mostrar loading
      errorMessage.classList.add("hidden");
      errorMessage.classList.remove("block");
      loadingMessage.classList.remove("hidden");
      loadingMessage.classList.add("block");
      submitBtn.disabled = true;

      try {
        // Obtener el nombre del plan para la API
        const apiNames =
          planApiNames ||
          (typeof window !== "undefined" ? window.planApiNames : null);
        const planType = apiNames ? apiNames[planToUse] : null;

        if (!planType) {
          throw new Error("Plan no válido");
        }

        // Construir URL con query params
        const apiUrl = new URL(
          "https://flow.wabotify.com/webhook/b99e1b24-f2d7-4d8c-8758-637fa6af4647",
        );
        apiUrl.searchParams.append("email", email);
        apiUrl.searchParams.append("plan_type", planType);

        // Hacer la consulta
        const response = await fetch(apiUrl.toString(), {
          method: "GET",
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        // Verificar que la respuesta tenga el link y el status
        if (!data.link) {
          throw new Error("No se recibió URL de redirección");
        }

        if (!data.status || (data.status !== "active_user" && data.status !== "new_user")) {
          throw new Error("Respuesta inválida del servidor");
        }

        // Ocultar loading y mostrar mensaje de éxito
        loadingMessage.classList.add("hidden");
        loadingMessage.classList.remove("block");
        const successMessage = document.getElementById("success-message");
        successMessage.classList.remove("hidden");
        successMessage.classList.add("block");

        // Esperar 1.5 segundos antes de redirigir
        setTimeout(() => {
          if (data.status === "active_user") {
            // Usuario activo: abrir en nueva pestaña
            window.open(data.link, "_blank");
            
            // Cerrar modal después de 500ms
            setTimeout(() => {
              closeModalHandler();
            }, 500);
          } else {
            // Usuario nuevo: redirigir en la misma página
            window.location.href = data.link;
          }
        }, 1500);
      } catch (error) {
        console.error("Error:", error);
        errorMessage.textContent =
          "Ocurrió un error. Por favor intenta de nuevo.";
        errorMessage.classList.remove("hidden");
        errorMessage.classList.add("block");
        loadingMessage.classList.add("hidden");
        loadingMessage.classList.remove("block");
        submitBtn.disabled = false;
      }
    });
</script>
