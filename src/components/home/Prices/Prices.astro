---
---

<script>
  let selectedPlan = null;
  let showModal = false;

  function openModal(plan) {
    selectedPlan = plan;
    showModal = true;
    document.body.style.overflow = "hidden";
    updateModal();
  }

  function closeModal() {
    showModal = false;
    document.body.style.overflow = "";
    updateModal();
  }

  function updateModal() {
    const modal = document.getElementById("plan-modal");
    if (modal) {
      modal.style.display = showModal ? "flex" : "none";
    }
  }

  // Cerrar modal al hacer click fuera del contenido
  window.addEventListener("click", function (e) {
    const modal = document.getElementById("plan-modal");
    if (showModal && modal && e.target === modal) {
      closeModal();
    }
  });
</script>

<section id="planes" class="py-12 md:py-16 lg:py-20 bg-gradient-to-br from-[var(--primary)] to-[var(--bg-secondary)] overflow-x-hidden transition-[background-color,color] duration-300">
  <div class="w-full max-w-[1200px] mx-auto px-4 sm:px-6 md:px-8 lg:px-10">
    <div class="text-center mb-10 md:mb-12 lg:mb-16 px-4 md:px-0 box-border">
      <h2 class="text-3xl md:text-4xl lg:text-5xl font-bold text-[var(--text-primary)] mb-4">Planes que se adaptan a tu negocio</h2>
      <p class="text-lg md:text-xl text-[var(--text-primary)] leading-relaxed">
        Desde emprendedores hasta grandes empresas, tenemos el plan perfecto
        para ti
      </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 mx-4 md:mx-0 items-stretch max-w-full md:max-w-[400px] md:mx-auto lg:max-w-none lg:mx-0">
      <div class="flex flex-col bg-[var(--bg-primary)]/80 backdrop-blur-[10px] p-6 md:p-7 lg:p-8 rounded-2xl border border-[var(--border-light)] shadow-[var(--theme-shadow-md)] transition-all duration-300 min-h-[360px] md:min-h-[380px] lg:min-h-[400px] hover:shadow-[var(--theme-shadow-lg),0_0_20px_rgba(26,109,204,0.2)] hover:border-[rgba(26,109,204,0.4)] lg:hover:-translate-y-1 [data-theme='light']_&:bg-[var(--bg-primary)] [data-theme='light']_&:border-[var(--border-color)] [data-theme='light']_&:hover:shadow-[var(--theme-shadow-lg),0_0_15px_rgba(26,109,204,0.1)]">
        <h3 class="text-2xl font-bold text-[var(--secondary)] mb-2">Empresa</h3>
        <div class="flex items-baseline gap-2 flex-wrap mb-6 md:mb-5">
          <span class="text-4xl md:text-[2.25rem] font-extrabold text-[var(--text-primary)] leading-none flex items-baseline">
            <span class="text-base align-super">$</span>1,075
          </span>
          <span class="text-base text-[var(--text-secondary)] font-medium whitespace-nowrap ml-1 opacity-90">por año</span>
        </div>

        <ul class="list-none p-0 mb-auto flex-grow space-y-2">
          <li class="flex items-center gap-3 text-[var(--text-primary)] text-[0.95rem] py-[0.4rem]">
            <span class="flex items-center justify-center w-5 h-5 rounded-full bg-[var(--accent)] text-white text-xs font-bold shrink-0">✓</span>
            1,200 timbres incluidos
          </li>
          <li class="flex items-center gap-3 text-[var(--text-primary)] text-[0.95rem] py-[0.4rem]">
            <span class="flex items-center justify-center w-5 h-5 rounded-full bg-[var(--accent)] text-white text-xs font-bold shrink-0">✓</span>
            50 Empresas
          </li>
          <li class="flex items-center gap-3 text-[var(--text-primary)] text-[0.95rem] py-[0.4rem]">
            <span class="flex items-center justify-center w-5 h-5 rounded-full bg-[var(--accent)] text-white text-xs font-bold shrink-0">✓</span>
            Facturas y complementos
          </li>
          <li class="flex items-center gap-3 text-[var(--text-primary)] text-[0.95rem] py-[0.4rem]">
            <span class="flex items-center justify-center w-5 h-5 rounded-full bg-[var(--accent)] text-white text-xs font-bold shrink-0">✓</span>
            Soporte por email
          </li>
        </ul>

        <button
          type="button"
          class="plan-button w-full flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all duration-200 cursor-pointer bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-md hover:-translate-y-1 hover:shadow-lg mt-4 shrink-0"
          data-plan="empresa"
        >
          Comenzar Ahora
        </button>
      </div>

      <div class="relative flex flex-col bg-[var(--bg-primary)]/80 backdrop-blur-[10px] p-6 md:p-8 rounded-2xl border-2 border-green-500 shadow-[var(--theme-shadow-lg),0_0_20px_rgba(34,197,94,0.3)] transition-all duration-300 hover:-translate-y-2 hover:shadow-[var(--theme-shadow-xl),0_0_30px_rgba(34,197,94,0.4)] scale-105">
        <div class="absolute -top-4 left-1/2 -translate-x-1/2 bg-green-500 text-white px-4 py-1 rounded-full text-sm font-semibold shadow-lg">
          Más Popular
        </div>
        <h3 class="text-xl md:text-2xl font-bold text-[var(--secondary)] mb-4 mt-2">Premium</h3>
        <div class="mb-6">
          <span class="block">
            <span class="text-4xl md:text-5xl font-bold text-[var(--text-primary)]">$2,324</span>
          </span>
          <span class="text-sm text-[var(--text-secondary)]">por año</span>
        </div>

        <ul class="list-none p-0 my-6 space-y-3 flex-1">
          <li class="flex items-start gap-2 text-[var(--text-secondary)]"><span class="text-[var(--secondary)] font-bold">✓</span> 6,000 timbres incluidos</li>
          <li class="flex items-start gap-2 text-[var(--text-secondary)]"><span class="text-[var(--secondary)] font-bold">✓</span> Empresas ilimitadas</li>
          <li class="flex items-start gap-2 text-[var(--text-secondary)]"><span class="text-[var(--secondary)] font-bold">✓</span> Envío por WhatsApp</li>
          <li class="flex items-start gap-2 text-[var(--text-secondary)]"><span class="text-[var(--secondary)] font-bold">✓</span> Descarga XML masiva</li>
          <li class="flex items-start gap-2 text-[var(--text-secondary)]"><span class="text-[var(--secondary)] font-bold">✓</span> Importa historial</li>
          <li class="flex items-start gap-2 text-[var(--text-secondary)]"><span class="text-[var(--secondary)] font-bold">✓</span> Conciliación bancaria</li>
          <li class="flex items-start gap-2 text-[var(--text-secondary)]"><span class="text-[var(--secondary)] font-bold">✓</span> Soporte prioritario</li>
        </ul>

        <button
          type="button"
          class="plan-button w-full flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all duration-200 cursor-pointer bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-md hover:-translate-y-1 hover:shadow-lg mt-4 shrink-0"
          data-plan="premium"
        >
          Más Popular
        </button>
      </div>

      <div class="flex flex-col bg-[var(--bg-primary)]/80 backdrop-blur-[10px] p-6 md:p-8 rounded-2xl border border-[var(--border-light)] shadow-[var(--theme-shadow-md)] transition-all duration-300 hover:-translate-y-2 hover:shadow-[var(--theme-shadow-xl)]">
        <h3 class="text-xl md:text-2xl font-bold text-[var(--secondary)] mb-4">Premium PLUS</h3>
        <div class="mb-6">
          <span class="block">
            <span class="text-4xl md:text-5xl font-bold text-[var(--text-primary)]">$3,135</span>
          </span>
          <span class="text-sm text-[var(--text-secondary)]">por año</span>
        </div>

        <ul class="list-none p-0 my-6 space-y-3 flex-1">
          <li class="flex items-start gap-2 text-[var(--text-secondary)]"><span class="text-[var(--secondary)] font-bold">✓</span> 10,000 timbres incluidos</li>
          <li class="flex items-start gap-2 text-[var(--text-secondary)]"><span class="text-[var(--secondary)] font-bold">✓</span> AutoFactura incluida</li>
          <li class="flex items-start gap-2 text-[var(--text-secondary)]"><span class="text-[var(--secondary)] font-bold">✓</span> WhatsApp con tu número</li>
          <li class="flex items-start gap-2 text-[var(--text-secondary)]"><span class="text-[var(--secondary)] font-bold">✓</span> Email personalizado</li>
          <li class="flex items-start gap-2 text-[var(--text-secondary)]"><span class="text-[var(--secondary)] font-bold">✓</span> Complementos avanzados</li>
          <li class="flex items-start gap-2 text-[var(--text-secondary)]"><span class="text-[var(--secondary)] font-bold">✓</span> Generación DIOT</li>
          <li class="flex items-start gap-2 text-[var(--text-secondary)]"><span class="text-[var(--secondary)] font-bold">✓</span> Soporte dedicado</li>
        </ul>

        <button
          type="button"
          class="plan-button w-full flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all duration-200 cursor-pointer bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-md hover:-translate-y-1 hover:shadow-lg mt-4 shrink-0"
          data-plan="premium-plus"
        >
          Plan Completo
        </button>
      </div>
    </div>
  </div>
</section>

<!-- Modal centrado para selección de cuenta -->
<style>
  #plan-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.45);
    align-items: center;
    justify-content: center;
  }
  #plan-modal.active {
    display: flex;
  }
  #plan-modal .modal-content {
    background: var(--bg-card);
    color: var(--text-primary);
    border-radius: 12px;
    max-width: 420px;
    width: 90vw;
    padding: 2rem 1.5rem 1.5rem 1.5rem;
    box-shadow: var(--theme-shadow-xl);
    border: 1px solid var(--border-color);
    text-align: center;
    position: relative;
  }
  #plan-modal .close-modal {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-muted);
    cursor: pointer;
    transition: color 0.2s;
  }
  #plan-modal .close-modal:hover {
    color: var(--text-primary);
  }
  #plan-modal .modal-title {
    font-size: 1.35rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--secondary);
  }
  #plan-modal .modal-subtitle {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
  }
  #plan-modal .form-group {
    text-align: left;
    margin-bottom: 1rem;
  }
  #plan-modal .form-group label {
    display: block;
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
  }
  #plan-modal .form-group input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    background: var(--bg-secondary);
    color: var(--text-primary);
    transition: border-color 0.2s;
    box-sizing: border-box;
  }
  #plan-modal .form-group input:focus {
    outline: none;
    border-color: var(--secondary);
    background: var(--bg-primary);
  }
  #plan-modal .plan-selected {
    background: var(--bg-secondary);
    padding: 0.75rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
    border: 1px solid var(--border-color);
  }
  #plan-modal .plan-selected strong {
    color: var(--secondary);
    text-transform: capitalize;
  }
  #plan-modal .modal-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.5rem;
  }
  #plan-modal .modal-actions button {
    flex: 1;
    padding: 0.85rem;
    border-radius: 8px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 1rem;
  }
  #plan-modal .modal-actions button.btn-submit {
    background: var(--secondary);
    color: #fff;
  }
  #plan-modal .modal-actions button.btn-submit:hover {
    background: var(--highlight-blue);
  }
  #plan-modal .modal-actions button.btn-submit:disabled {
    background: var(--text-muted);
    cursor: not-allowed;
    opacity: 0.5;
  }
  #plan-modal .modal-actions button.btn-cancel {
    background: var(--bg-secondary);
    color: var(--secondary);
    border: 1px solid var(--secondary);
  }
  #plan-modal .modal-actions button.btn-cancel:hover {
    background: var(--bg-tertiary);
  }
  #plan-modal .error-message {
    color: #dc3545;
    font-size: 0.85rem;
    margin-top: 0.5rem;
    display: none;
  }
  #plan-modal .error-message.show {
    display: block;
  }
  #plan-modal .loading {
    display: none;
    margin-top: 1rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
  }
  #plan-modal .loading.show {
    display: block;
  }
  #plan-modal .success-message {
    display: none;
    margin-top: 1rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border: 1px solid var(--accent);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 0.95rem;
    line-height: 1.5;
  }
  #plan-modal .success-message.show {
    display: block;
  }
  #plan-modal .success-message strong {
    color: var(--accent);
    display: block;
    margin-bottom: 0.5rem;
  }
</style>
<div id="plan-modal">
  <div class="modal-content">
    <button class="close-modal" aria-label="Cerrar">&times;</button>
    <div class="modal-title">Continuar con tu compra</div>
    <div class="modal-subtitle">
      Ingresa tu correo electrónico para continuar
    </div>

    <form id="plan-form">
      <div class="form-group">
        <label for="email-input">Correo electrónico:</label>
        <input
          type="email"
          id="email-input"
          name="email"
          placeholder="tu@correo.com"
          required
          autocomplete="email"
        />
      </div>

      <div class="plan-selected">
        Plan seleccionado: <strong id="selected-plan-name">-</strong>
      </div>

      <div class="error-message" id="error-message"></div>
      <div class="loading" id="loading-message">Procesando...</div>
      <div class="success-message" id="success-message">
        <strong>✓ Redirigiendo...</strong>
        Serás redirigido a otra página para completar tu pago.
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-cancel">Cancelar</button>
        <button type="submit" class="btn-submit">Continuar</button>
      </div>
    </form>
  </div>
</div>
<script>
  // Variable global para compartir con Table.astro
  if (typeof window !== "undefined") {
    window.currentPlan = null;
  }
  let currentPlan = null;

  // Mapeo de planes a nombres de API (con guión bajo) - compartido globalmente
  if (typeof window !== "undefined") {
    window.planApiNames = {
      emprende: "emprende",
      crece: "crece",
      empresa: "empresa",
      premium: "premium",
      "premium-plus": "premium_plus",
    };
  }
  const planApiNames = {
    emprende: "emprende",
    crece: "crece",
    empresa: "empresa",
    premium: "premium",
    "premium-plus": "premium_plus",
  };

  // URLs de fallback por si falla la API
  const planUrls = {
    emprende: {
      subscribe:
        "https://pagos.solucionfiscal.online/subscribe/6677460f60546edc2553076f/plan-emprende",
      register: "https://app.solucionfactura.mx/register?plan=emprende",
    },
    crece: {
      subscribe:
        "https://pagos.solucionfiscal.online/subscribe/6677544560546edc255308ea/plan-crece",
      register: "https://app.solucionfactura.mx/register?plan=crece",
    },
    empresa: {
      subscribe:
        "https://pagos.solucionfiscal.online/subscribe/667754e89b6a9adc0e5693f1/plan-empresa",
      register: "https://app.solucionfactura.mx/register?plan=empresa",
    },
    premium: {
      subscribe:
        "https://pagos.solucionfiscal.online/subscribe/6677554f9b6a9adc0e5693f6/plan-premium",
      register: "https://app.solucionfactura.mx/register?plan=premium",
    },
    "premium-plus": {
      subscribe:
        "https://pagos.solucionfiscal.online/subscribe/667756fe9b6a9adc0e569424/plan-premium-plus",
      register: "https://app.solucionfactura.mx/register?plan=premium-plus",
    },
  };

  // Función para formatear el nombre del plan
  function formatPlanName(plan) {
    return plan.replace(/-/g, " ").replace(/\b\w/g, (l) => l.toUpperCase());
  }

  // Abrir modal al hacer click en cualquier botón de plan
  document.querySelectorAll(".plan-button").forEach((btn) => {
    btn.addEventListener("click", function (e) {
      e.preventDefault();
      currentPlan = btn.getAttribute("data-plan");
      if (typeof window !== "undefined") {
        window.currentPlan = currentPlan;
      }
      const modal = document.getElementById("plan-modal");
      const planNameEl = document.getElementById("selected-plan-name");
      const emailInput = document.getElementById("email-input");
      const errorMessage = document.getElementById("error-message");

      // Actualizar nombre del plan
      planNameEl.textContent = formatPlanName(currentPlan);

      // Limpiar formulario
      emailInput.value = "";
      errorMessage.classList.remove("show");
      errorMessage.textContent = "";

      // Mostrar modal
      modal.classList.add("active");
      document.body.style.overflow = "hidden";

      // Focus en el input
      setTimeout(() => emailInput.focus(), 100);
    });
  });

  // Cerrar modal
  function closeModalHandler() {
    const modal = document.getElementById("plan-modal");
    const submitBtn = document.querySelector(".btn-submit");
    const successMessage = document.getElementById("success-message");
    const loadingMessage = document.getElementById("loading-message");
    const errorMessage = document.getElementById("error-message");

    modal.classList.remove("active");
    document.body.style.overflow = "";
    currentPlan = null;
    if (typeof window !== "undefined") {
      window.currentPlan = null;
    }

    // Resetear estado del botón y mensajes
    if (submitBtn) submitBtn.disabled = false;
    if (successMessage) successMessage.classList.remove("show");
    if (loadingMessage) loadingMessage.classList.remove("show");
    if (errorMessage) errorMessage.classList.remove("show");
  }

  // Cerrar modal al hacer click en la X o botón cancelar
  document
    .querySelector("#plan-modal .close-modal")
    .addEventListener("click", closeModalHandler);
  document
    .querySelector("#plan-modal .btn-cancel")
    .addEventListener("click", closeModalHandler);

  // Cerrar modal al hacer click fuera del contenido
  document.getElementById("plan-modal").addEventListener("click", function (e) {
    if (e.target === this) {
      closeModalHandler();
    }
  });

  // Manejar envío del formulario
  document
    .getElementById("plan-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const emailInput = document.getElementById("email-input");
      const submitBtn = document.querySelector(".btn-submit");
      const errorMessage = document.getElementById("error-message");
      const loadingMessage = document.getElementById("loading-message");
      const email = emailInput.value.trim();

      // Obtener currentPlan de variable local o global
      const planToUse =
        currentPlan ||
        (typeof window !== "undefined" ? window.currentPlan : null);

      if (!email || !planToUse) return;

      // Validar email básico
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        errorMessage.textContent = "Por favor ingresa un correo válido";
        errorMessage.classList.add("show");
        return;
      }

      // Ocultar error y mostrar loading
      errorMessage.classList.remove("show");
      loadingMessage.classList.add("show");
      submitBtn.disabled = true;

      try {
        // Obtener el nombre del plan para la API
        const apiNames =
          planApiNames ||
          (typeof window !== "undefined" ? window.planApiNames : null);
        const planType = apiNames ? apiNames[planToUse] : null;

        if (!planType) {
          throw new Error("Plan no válido");
        }

        // Construir URL con query params
        const apiUrl = new URL(
          "https://flow.wabotify.com/webhook/get-correct-link",
        );
        apiUrl.searchParams.append("email", email);
        apiUrl.searchParams.append("plan_type", planType);

        // Hacer la consulta
        const response = await fetch(apiUrl.toString(), {
          method: "GET",
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        // Verificar que la respuesta sea exitosa y tenga el link
        if (data.status !== "success" || !data.link) {
          throw new Error("No se recibió URL de redirección");
        }

        // Ocultar loading y mostrar mensaje de éxito
        loadingMessage.classList.remove("show");
        const successMessage = document.getElementById("success-message");
        successMessage.classList.add("show");

        // Esperar 1.5 segundos antes de redirigir
        setTimeout(() => {
          // Abrir el link en nueva ventana
          window.open(data.link, "_blank");

          // Cerrar modal después de 500ms
          setTimeout(() => {
            closeModalHandler();
          }, 500);
        }, 1500);
      } catch (error) {
        console.error("Error:", error);
        errorMessage.textContent =
          "Ocurrió un error. Por favor intenta de nuevo.";
        errorMessage.classList.add("show");
        loadingMessage.classList.remove("show");
        submitBtn.disabled = false;
      }
    });
</script>
