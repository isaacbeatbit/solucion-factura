---
// WhatsAppFloat.astro - Widget flotante de contacto optimizado
---

<!-- WIDGET DE CONTACTO FLOTANTE -->
<div class="contact-widget">
  <div class="widget-bubble">
    <div class="widget-menu" id="widgetMenu">
      <div class="widget-header">
        <h3 class="widget-title">¡Contáctanos!</h3>
        <p class="widget-subtitle">Estamos aquí para ayudarte</p>
      </div>
      <div class="widget-content">
        <div class="widget-section">
          <h4 class="section-title">
            <svg class="section-icon whatsapp-icon" viewBox="0 0 24 24">
              <path
                d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.525 3.687"
              ></path>
            </svg>
            WhatsApp
          </h4>
          <div class="widget-options">
            <a
              href="https://wa.me/525576017764?text=Hola,%20deseo%20información%20de%20planes"
              class="widget-btn whatsapp-btn"
              target="_blank"
              rel="noopener noreferrer"
              aria-label="Contactar vía WhatsApp para información de planes"
            >
              <svg class="btn-icon whatsapp-icon" viewBox="0 0 24 24">
                <use href="#whatsapp-icon"></use>
              </svg>
              <span class="btn-text">Información de Planes</span>
            </a>
            <a
              href="https://wa.me/525576017764?text=Deseo%20soporte%20técnico"
              class="widget-btn whatsapp-btn"
              target="_blank"
              rel="noopener noreferrer"
              aria-label="Contactar vía WhatsApp para soporte técnico"
            >
              <svg class="btn-icon whatsapp-icon" viewBox="0 0 24 24">
                <use href="#whatsapp-icon"></use>
              </svg>
              <span class="btn-text">Soporte Técnico</span>
            </a>
          </div>
        </div>

        <div class="widget-section">
          <h4 class="section-title">
            <svg class="section-icon" viewBox="0 0 24 24">
              <path
                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
              ></path>
            </svg>
            Otros Canales
          </h4>
          <div class="widget-options">
            <a
              href="https://www.facebook.com/solucionfactura"
              class="widget-btn facebook-btn"
              target="_blank"
              rel="noopener noreferrer"
              aria-label="Visitar página de Facebook"
            >
              <svg class="btn-icon" viewBox="0 0 24 24">
                <path
                  d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"
                ></path>
              </svg>
              <span class="btn-text">Facebook</span>
            </a>
            <a
              href="https://solucioncrm.mx/app/solucion/ps/knowledge-base/category/soporte"
              class="widget-btn knowledge-btn"
              target="_blank"
              rel="noopener noreferrer"
              aria-label="Acceder a la base de conocimiento"
            >
              <svg class="btn-icon" viewBox="0 0 24 24">
                <path
                  d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"
                ></path>
              </svg>
              <span class="btn-text">Base de Conocimiento</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <button
      class="widget-toggle"
      id="widgetToggle"
      aria-label="Abrir menú de contacto"
      aria-expanded="false"
      type="button"
    >
      <svg class="widget-icon chat whatsapp-icon" viewBox="0 0 24 24">
        <use href="#whatsapp-icon"></use>
      </svg>
      <svg class="widget-icon close" viewBox="0 0 24 24">
        <path
          d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
        ></path>
      </svg>
    </button>
  </div>
</div>

<!-- SVG Definitions para reutilización -->
<svg style="display: none;" aria-hidden="true">
  <defs>
    <symbol id="whatsapp-icon" viewBox="0 0 24 24">
      <path
        d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.525 3.687"
      ></path>
    </symbol>
  </defs>
</svg>

<style lang="scss">
  /* WIDGET FLOTANTE OPTIMIZADO */
  .contact-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 999999; /* Aumentado para asegurar que esté por encima de todo */
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }

  .widget-bubble {
    position: relative;
  }

  .widget-toggle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #25d366, #128c7e);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 20px rgba(37, 211, 102, 0.4);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    animation: pulse 2s infinite;
    position: relative; /* Añadido para el posicionamiento absoluto de iconos */
  }

  .widget-toggle:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(37, 211, 102, 0.5);
  }

  .widget-toggle:focus-visible {
    outline: 2px solid #25d366;
    outline-offset: 3px;
  }

  .widget-toggle.active {
    background: linear-gradient(135deg, #ff6b6b, #ee5a24);
    animation: none;
  }

  @keyframes pulse {
    0% {
      box-shadow: 0 4px 20px rgba(37, 211, 102, 0.4);
    }
    50% {
      box-shadow:
        0 4px 20px rgba(37, 211, 102, 0.6),
        0 0 0 10px rgba(37, 211, 102, 0.1);
    }
    100% {
      box-shadow: 0 4px 20px rgba(37, 211, 102, 0.4);
    }
  }

  .widget-icon {
    width: 28px;
    height: 28px;
    fill: white;
    transition: all 0.3s ease;
    position: absolute; /* Posicionamiento absoluto para mejor superposición */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .widget-toggle.active .widget-icon.chat {
    opacity: 0;
    transform: translate(-50%, -50%) rotate(180deg);
  }

  .widget-toggle.active .widget-icon.close {
    opacity: 1;
    transform: translate(-50%, -50%) rotate(0deg);
  }

  .widget-icon.close {
    opacity: 0;
    transform: translate(-50%, -50%) rotate(-180deg);
  }

  .widget-menu {
    position: absolute;
    bottom: 70px;
    right: 0;
    background: white;
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    min-width: 280px;
    max-width: 320px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px) scale(0.8);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid #e1e8ed;

    /* Support for dark theme */
    [data-theme="dark"] & {
      background: var(--bg-card, #0f172a);
      border-color: var(--border-light, rgba(161, 179, 204, 0.2));
      color: var(--text-primary, #e1e5ee);
    }
  }

  .widget-menu.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
  }

  .widget-header {
    padding: 20px 20px 15px;
    text-align: center;
    border-bottom: 1px solid #f0f2f5;

    [data-theme="dark"] & {
      border-bottom-color: var(--border-light, rgba(161, 179, 204, 0.2));
    }
  }

  .widget-title {
    font-size: 18px;
    font-weight: 700;
    color: #333;
    margin: 0 0 5px 0;

    [data-theme="dark"] & {
      color: var(--text-primary, #e1e5ee);
    }
  }

  .widget-subtitle {
    font-size: 13px;
    color: #666;
    margin: 0;

    [data-theme="dark"] & {
      color: var(--text-secondary, #a7b3cc);
    }
  }

  .widget-content {
    padding: 15px;
  }

  .widget-section {
    margin-bottom: 20px;
  }

  .widget-section:last-child {
    margin-bottom: 0;
  }

  .section-title {
    font-size: 14px;
    font-weight: 600;
    color: #444;
    margin: 0 0 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;

    [data-theme="dark"] & {
      color: var(--text-primary, #e1e5ee);
    }
  }

  .section-icon {
    width: 16px;
    height: 16px;
    fill: currentColor;
    flex-shrink: 0;
  }

  .widget-options {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .widget-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 15px;
    border: none;
    border-radius: 10px;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
    color: inherit;
  }

  .widget-btn:focus-visible {
    outline: 2px solid currentColor;
    outline-offset: 2px;
  }

  .whatsapp-btn {
    background: linear-gradient(135deg, #25d366, #20bf5a);
    color: white;
  }

  .whatsapp-btn:hover {
    background: linear-gradient(135deg, #20bf5a, #1da851);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
  }

  .facebook-btn {
    background: linear-gradient(135deg, #1877f2, #166fe5);
    color: white;
  }

  .facebook-btn:hover {
    background: linear-gradient(135deg, #166fe5, #1464d8);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(24, 119, 242, 0.3);
  }

  .knowledge-btn {
    background: linear-gradient(135deg, #6c5ce7, #5f4bdb);
    color: white;
  }

  .knowledge-btn:hover {
    background: linear-gradient(135deg, #5f4bdb, #5240ce);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
  }

  .btn-icon {
    width: 18px;
    height: 18px;
    fill: currentColor;
    flex-shrink: 0;
  }

  .btn-text {
    flex: 1;
    color: inherit;
  }

  /* Responsive optimizado */
  @media (max-width: 480px) {
    .contact-widget {
      bottom: 15px;
      right: 15px;
    }

    .widget-menu {
      min-width: 260px;
      max-width: calc(100vw - 40px);
      right: -5px; /* Mejor alineación en móvil */
    }

    .widget-toggle {
      width: 55px;
      height: 55px;
    }

    .widget-icon {
      width: 24px;
      height: 24px;
    }
  }

  /* Tooltip mejorado */
  .widget-bubble::before {
    content: "¡Contáctanos!";
    position: absolute;
    bottom: 70px;
    right: 5px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.3s ease;
    pointer-events: none;
    z-index: 10;
  }

  .widget-bubble:hover::before {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .widget-menu.active ~ .widget-toggle + .widget-bubble::before,
  .widget-toggle.active ~ .widget-bubble::before {
    display: none;
  }

  /* Animation for entrance mejorado */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .contact-widget {
    animation: fadeInUp 0.6s ease forwards;
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .widget-toggle {
      animation: none;
    }

    .widget-btn,
    .widget-menu,
    .widget-icon {
      transition: none;
    }

    .contact-widget {
      animation: none;
    }
  }

  /* Print styles */
  @media print {
    .contact-widget {
      display: none !important;
    }
  }

  /* High contrast mode */
  @media (prefers-contrast: high) {
    .widget-menu {
      border: 2px solid currentColor;
    }

    .widget-btn {
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
  }
</style>

<script>
  // Widget functionality mejorado con manejo de errores
  function initContactWidget() {
    try {
      const widgetToggle = document.getElementById("widgetToggle");
      const widgetMenu = document.getElementById("widgetMenu");

      if (!widgetToggle || !widgetMenu) {
        console.warn("Contact widget elements not found");
        return;
      }

      let isOpen = false;

      // Toggle widget menu
      const toggleWidget = () => {
        isOpen = !isOpen;

        try {
          if (isOpen) {
            widgetMenu.classList.add("active");
            widgetToggle.classList.add("active");
            widgetToggle.setAttribute("aria-expanded", "true");
            widgetToggle.setAttribute("aria-label", "Cerrar menú de contacto");
          } else {
            widgetMenu.classList.remove("active");
            widgetToggle.classList.remove("active");
            widgetToggle.setAttribute("aria-expanded", "false");
            widgetToggle.setAttribute("aria-label", "Abrir menú de contacto");
          }
        } catch (error) {
          console.error("Error toggling widget:", error);
        }
      };

      widgetToggle.addEventListener("click", toggleWidget);

      // Close widget when clicking outside
      const handleOutsideClick = (e) => {
        if (!e.target.closest(".contact-widget") && isOpen) {
          isOpen = false;
          widgetMenu.classList.remove("active");
          widgetToggle.classList.remove("active");
          widgetToggle.setAttribute("aria-expanded", "false");
          widgetToggle.setAttribute("aria-label", "Abrir menú de contacto");
        }
      };

      document.addEventListener("click", handleOutsideClick);

      // Close widget when pressing Escape key
      const handleEscapeKey = (e) => {
        if (e.key === "Escape" && isOpen) {
          isOpen = false;
          widgetMenu.classList.remove("active");
          widgetToggle.classList.remove("active");
          widgetToggle.setAttribute("aria-expanded", "false");
          widgetToggle.setAttribute("aria-label", "Abrir menú de contacto");
          widgetToggle.focus(); // Devolver el foco al botón
        }
      };

      document.addEventListener("keydown", handleEscapeKey);

      // Analytics tracking mejorado
      const trackWidgetInteraction = (action, label) => {
        try {
          // Google Analytics 4
          if (typeof gtag !== "undefined") {
            gtag("event", action, {
              event_category: "contact_widget",
              event_label: label,
              value: 1,
            });
          }

          // Fallback a console para desarrollo
          console.log(`Contact widget interaction: ${action} - ${label}`);
        } catch (error) {
          console.error("Error tracking widget interaction:", error);
        }
      };

      // Track button clicks
      document.querySelectorAll(".widget-btn").forEach((btn) => {
        btn.addEventListener("click", function (e) {
          const label =
            this.querySelector(".btn-text")?.textContent?.trim() || "Unknown";
          trackWidgetInteraction("click", label);
        });
      });

      // Track widget open/close
      widgetToggle.addEventListener("click", () => {
        trackWidgetInteraction(isOpen ? "close" : "open", "widget_toggle");
      });

      // Cleanup function para evitar memory leaks
      window.addEventListener("beforeunload", () => {
        document.removeEventListener("click", handleOutsideClick);
        document.removeEventListener("keydown", handleEscapeKey);
      });
    } catch (error) {
      console.error("Error initializing contact widget:", error);
    }
  }

  // Inicializar con mejor manejo de estados
  const initWidget = () => {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initContactWidget);
    } else {
      // Pequeño delay para asegurar que todos los elementos estén renderizados
      setTimeout(initContactWidget, 100);
    }
  };

  // Inicializar inmediatamente
  initWidget();

  // Re-inicializar en navegación de Astro
  document.addEventListener("astro:page-load", initContactWidget);
</script>
